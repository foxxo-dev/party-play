<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Become Host</title>
    <link rel="stylesheet" href="../styles/reset.css" />
    <link rel="stylesheet" href="../styles/becomehost.css" />
    <style>
      a {
        max-width: 50ch;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <p>We are creating your playlist now...</p>
  </body>

  <script type="module">
    import { createAttr } from '../js/attribution';
    import {
      createPublicPlaylist,
      addRecommendedTracks
    } from '../js/spotify-calls';
    import { parseURLParams } from '../js/params-parser.js';
    import QRCode from 'qrcode';

    const response = parseURLParams(window.location.href);
    var Uid = '';
    var token = '';

    if (response) {
      Uid = response.returnUserCode[0];
      token = response.token[0];
      const playlist = await createPublicPlaylist(token);
      addRecommendedTracks(token, playlist.id);
      // const playlist = { id: 'test-234' };

      document.body.innerHTML = `<h1>Playlist Created!</h1>
        <h2>Share this URL with anyone, to add songs to the playlist!</h2>
        <div class="main">
        <div class='url-container'>
          <button>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" hi-documents"><path xmlns="http://www.w3.org/2000/svg" stroke-linejoin="round" stroke-width="2" d="M13 3v7h7M6 7H5a1 1 0 00-1 1v12a1 1 0 001 1h9a1 1 0 001-1v-1M8 4v12a1 1 0 001 1h10a1 1 0 001-1V9.389a1 1 0 00-.263-.676l-4.94-5.389A1 1 0 0014.06 3H9a1 1 0 00-1 1z"/></svg>
            <div class='tooltip'>
              <span>Copy URL</span>
            </div>
          </button>                                                 
          <a href="/addSong/index.html?playlistId=${playlist.id}&userId=${Uid}&token=${token}">
                  https://party-play.foxxo.studio/addSong/index.html?playlistId=SECRET&userId=SECRET&token=SECRET
          </a>
        </div>
        <canvas id="qrcode"></canvas>
        </div>`;

      QRCode.toCanvas(
        document.getElementById('qrcode'),
        `https://party-play.foxxo.studio/addSong/index.html?playlistId=${playlist.id}&userId=${Uid}&token=${token}`,
        function (error) {
          if (error) console.error(error);
          console.log('success!');
        }
      );

      createAttr(document.body);
    } else {
      const scopes = ['playlist-modify-public', 'user-top-read'];
      window.location.href = `https://accounts.spotify.com/authorize?client_id=45b1711a56714857811215f27b15ffc7&response_type=code&redirect_uri=https://party-play.foxxo.studio/auth/process.html&scope=${scopes.join(
        '%20'
      )}&state=123`;
    }
    console.log(Uid);
  </script>
</html>
